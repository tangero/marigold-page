name: Send OneSignal Notifications (Improved)

on:
  push:
    branches:
      - main
    paths:
      - '_posts/**/*.md'
      - '_vibecoding/**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 10  # Zv√Ω≈°eno z 2 na 10 pro spolehlivost

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml

    - name: üîê Validate Secrets
      run: |
        echo "Kontroluji OneSignal secrets..."

        if [ -z "$ONESIGNAL_REST_API_KEY" ]; then
          echo "::error::‚ùå ONESIGNAL_REST_API_KEY nen√≠ nastaven√Ω!"
          echo "::error::P≈ôidejte ho v Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "::error::URL: https://github.com/${{ github.repository }}/settings/secrets/actions"
          exit 1
        fi

        if [ -z "$ONESIGNAL_MARIGOLD_APP_ID" ]; then
          echo "::error::‚ùå ONESIGNAL_MARIGOLD_APP_ID nen√≠ nastaven√Ω!"
          echo "::error::P≈ôidejte ONESIGNAL_APP_ID secret s hodnotou: 00fc3def-70d1-4e7d-a081-984d5e738a75"
          exit 1
        fi

        echo "‚úÖ V≈°echny secrets jsou nastaven√©"
        echo "API Key length: ${#ONESIGNAL_REST_API_KEY} chars"
        echo "App ID: $ONESIGNAL_MARIGOLD_APP_ID"
      env:
        ONESIGNAL_REST_API_KEY: ${{ secrets.ONESIGNAL_REST_API_KEY }}
        ONESIGNAL_MARIGOLD_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}

    - name: üì§ Send Notifications
      env:
        ONESIGNAL_REST_API_KEY: ${{ secrets.ONESIGNAL_REST_API_KEY }}
        ONESIGNAL_MARIGOLD_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
        ONESIGNAL_VIBECODING_APP_ID: 0c413930-f7f6-4d73-9438-36ec057acb7d
      run: |
        echo "üîî Spou≈°t√≠m notifikaƒçn√≠ skript..."
        python .github/scripts/send_notifications.py
        EXIT_CODE=$?

        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Notifikace √∫spƒõ≈°nƒõ odesl√°ny"
        else
          echo "::error::‚ùå Notifikaƒçn√≠ skript selhal s exit code: $EXIT_CODE"
          exit $EXIT_CODE
        fi

    - name: üìä Log Summary
      if: always()
      run: |
        echo "=== GitHub Actions Summary ==="
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "Workflow status: ${{ job.status }}"

    - name: üö® Notify on Failure
      if: failure()
      run: |
        echo "::error::========================================"
        echo "::error::‚ùå WORKFLOW SELHAL!"
        echo "::error::========================================"
        echo "::error::"
        echo "::error::Mo≈æn√© p≈ô√≠ƒçiny:"
        echo "::error::1. Chybƒõj√≠c√≠ GitHub Secrets"
        echo "::error::2. OneSignal API error"
        echo "::error::3. Network timeout"
        echo "::error::4. Python script error"
        echo "::error::"
        echo "::error::Jak opravit:"
        echo "::error::1. Zkontrolujte logs v√Ω≈°e"
        echo "::error::2. Ovƒõ≈ôte secrets v Settings ‚Üí Secrets"
        echo "::error::3. Zkuste poslat notifikaci manu√°lnƒõ:"
        echo "::error::   python3 send_notification_now.py"
        echo "::error::"
        echo "::error::Podrobn√° anal√Ωza: NOTIFICATION_FAILURE_ANALYSIS.md"
        echo "::error::========================================"
